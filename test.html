<!DOCTYPE html>
<html>
<head>
    <title>Lyrics-to-Music Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
        textarea { width: 100%; height: 200px; margin-bottom: 20px; }
        button { padding: 10px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        #output { margin-top: 20px; border: 1px solid #ddd; padding: 20px; }
    </style>
</head>
<body>
    <h1>Lyrics-to-Music Generator</h1>
    <textarea id="lyrics" placeholder="Paste your lyrics here...">
[Pre-Chorus: Bang Chan, Felix]
Blurry lines (Yeah, yeah, yeah)
So many, so many, any-anything, no, not that
Blurry lines (Yeah, yeah, yeah)
So many, so many, any-anything, no, not that
You don't want this or that
What do you want, baby? What do you want?

[Chorus: Lee Know, (Felix), Seungmin, Changbin, Han]
There's so many different things but nothing feels right
There's so many different things but I drop it all
I end up dropping it all anyway
Do I have to go off to some other planet or something?
There's so many different things but nothing feels right
There's so many different things but I drop it all
I end up dropping it all anyway
It's all just no, no, no, ow</textarea>
    <button id="generate">Generate Music</button>
    <div id="output"></div>

    <script>
        // Initialize Tone.js
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();
        const drumSampler = new Tone.Sampler({
            urls: {
                A1: "kick.mp3",
                C2: "snare.mp3",
                D2: "hihat.mp3"
            },
            release: 1,
            baseUrl: "https://tonejs.github.io/audio/drum-samples/electronic/"
        }).toDestination();

        // Emotion mapping to musical parameters
        const emotionToMusic = {
            'joy': { tempo: 120, scale: 'C major', chords: ['C', 'G', 'F'], intensity: 0.8 },
            'anger': { tempo: 140, scale: 'D minor', chords: ['Dm', 'A', 'G'], intensity: 1 },
            'sadness': { tempo: 70, scale: 'A minor', chords: ['Am', 'F', 'G'], intensity: 0.5 },
            'fear': { tempo: 100, scale: 'E minor', chords: ['Em', 'B', 'C'], intensity: 0.6 },
            'surprise': { tempo: 110, scale: 'G major', chords: ['G', 'D', 'Em'], intensity: 0.7 },
            'love': { tempo: 90, scale: 'F major', chords: ['F', 'C', 'Dm'], intensity: 0.7 },
            'default': { tempo: 100, scale: 'C major', chords: ['C', 'G', 'Am', 'F'], intensity: 0.7 }
        };

        // Load Universal Sentence Encoder for emotion analysis
        let useModel;
        async function loadModels() {
            useModel = await use.load();
            document.getElementById('output').innerHTML = "Models loaded! Paste lyrics and click Generate.";
        }

        // Analyze lyrics emotion
        async function analyzeEmotion(text) {
            const sentences = text.split('\n').filter(line => line.trim() !== '');
            const embeddings = await useModel.embed(sentences);
            const emotions = [];
            
            // Simple emotion classifier (replace with proper model in production)
            for (let i = 0; i < sentences.length; i++) {
                const sentence = sentences[i];
                let emotion = 'default';
                
                if (sentence.toLowerCase().includes('happy') || sentence.toLowerCase().includes('yeah')) {
                    emotion = 'joy';
                } else if (sentence.toLowerCase().includes('no') || sentence.toLowerCase().includes('not')) {
                    emotion = 'anger';
                } else if (sentence.toLowerCase().includes('sad') || sentence.toLowerCase().includes('drop')) {
                    emotion = 'sadness';
                }
                
                emotions.push(emotion);
            }
            
            // Get most common emotion
            const emotionCounts = emotions.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
            
            return Object.keys(emotionCounts).reduce((a, b) => 
                emotionCounts[a] > emotionCounts[b] ? a : b
            );
        }

        // Generate melody based on emotion
        function generateMelody(emotion) {
            const settings = emotionToMusic[emotion] || emotionToMusic['default'];
            const notes = [];
            
            // Simple melody generation based on scale and tempo
            const scaleNotes = getScaleNotes(settings.scale);
            for (let i = 0; i < 16; i++) {
                const note = scaleNotes[Math.floor(Math.random() * scaleNotes.length)];
                notes.push({
                    time: i * 0.5,
                    note: note,
                    duration: 0.3 + Math.random() * 0.5
                });
            }
            
            return {
                notes: notes,
                tempo: settings.tempo,
                chords: settings.chords,
                intensity: settings.intensity
            };
        }

        // Get notes in a scale
        function getScaleNotes(scale) {
            const scales = {
                'C major': ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4'],
                'A minor': ['A4', 'B4', 'C5', 'D5', 'E5', 'F5', 'G5'],
                'G major': ['G4', 'A4', 'B4', 'C5', 'D5', 'E5', 'F#5'],
                'D minor': ['D4', 'E4', 'F4', 'G4', 'A4', 'Bb4', 'C5'],
                'F major': ['F4', 'G4', 'A4', 'Bb4', 'C5', 'D5', 'E5'],
                'E minor': ['E4', 'F#4', 'G4', 'A4', 'B4', 'C5', 'D5']
            };
            return scales[scale] || scales['C major'];
        }

        // Generate drum pattern
        function generateDrums(emotion) {
            const settings = emotionToMusic[emotion] || emotionToMusic['default'];
            const pattern = [];
            
            // Simple drum pattern based on tempo
            for (let i = 0; i < 8; i++) {
                pattern.push({
                    time: i * 0.5,
                    note: 'A1', // Kick
                    duration: 0.1
                });
                
                if (i % 2 === 0) {
                    pattern.push({
                        time: i * 0.5 + 0.25,
                        note: 'D2', // Hi-hat
                        duration: 0.1
                    });
                }
                
                if (i % 4 === 2) {
                    pattern.push({
                        time: i * 0.5 + 0.125,
                        note: 'C2', // Snare
                        duration: 0.1
                    });
                }
            }
            
            return pattern;
        }

        // Play the generated music
        async function playMusic(melody, drums) {
            Tone.Transport.bpm.value = melody.tempo;
            
            // Schedule melody notes
            melody.notes.forEach(note => {
                synth.triggerAttackRelease(
                    note.note, 
                    note.duration, 
                    Tone.now() + note.time
                );
            });
            
            // Schedule drums
            drums.forEach(drum => {
                drumSampler.triggerAttackRelease(
                    drum.note,
                    drum.duration,
                    Tone.now() + drum.time
                );
            });
            
            // Start transport
            await Tone.start();
            Tone.Transport.start();
            
            // Stop after 8 seconds
            setTimeout(() => {
                Tone.Transport.stop();
            }, 8000);
        }

        // Main generation function
        document.getElementById('generate').addEventListener('click', async function() {
            const lyrics = document.getElementById('lyrics').value;
            document.getElementById('output').innerHTML = "Analyzing lyrics...";
            
            try {
                // Analyze emotion
                const emotion = await analyzeEmotion(lyrics);
                document.getElementById('output').innerHTML = 
                    `Detected emotion: ${emotion}<br>Generating music...`;
                
                // Generate music
                const melody = generateMelody(emotion);
                const drums = generateDrums(emotion);
                
                document.getElementById('output').innerHTML = 
                    `Playing music with ${emotion} feeling (Tempo: ${melody.tempo} BPM, Scale: ${melody.scale})...`;
                
                // Play the music
                await playMusic(melody, drums);
                
            } catch (error) {
                document.getElementById('output').innerHTML = 
                    `Error: ${error.message}`;
                console.error(error);
            }
        });

        // Load models when page loads
        loadModels();
    </script>
</body>
</html>