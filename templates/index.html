<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music & Lyrics Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ffeb3b;
            --secondary: #000;
            --accent: #ff5722;
            --text-light: #f5f5f5;
            --text-dark: #333;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: var(--secondary);
            color: var(--primary);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        /* Navbar */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 5%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 235, 59, 0.2);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            font-weight: bold;
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Main content */
        main {
            padding: 120px 5% 80px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Generator sections */
        .generator-section {
            background-color: rgba(30, 30, 30, 0.7);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 235, 59, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .section-title {
            font-size: 2rem;
            margin-bottom: 20px;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
            font-weight: 500;
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 235, 59, 0.3);
            background-color: rgba(50, 50, 50, 0.7);
            color: var(--text-light);
            font-size: 1rem;
            transition: border 0.3s ease;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: var(--secondary);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 235, 59, 0.3);
        }
        
        /* Results section */
        .result-container {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .result-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .lyrics-result {
            white-space: pre-wrap;
            background-color: rgba(40, 40, 40, 0.7);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 235, 59, 0.2);
            margin-bottom: 20px;
        }
        
        .audio-player {
            width: 100%;
            margin-top: 20px;
            border-radius: 8px;
            background-color: rgba(40, 40, 40, 0.7);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background-color: rgba(255, 235, 59, 0.1);
            color: var(--primary);
            border: 1px solid rgba(255, 235, 59, 0.3);
        }
        
        .btn-secondary:hover {
            background-color: rgba(255, 235, 59, 0.2);
        }
        
        /* Status indicators */
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .status-processing {
            background-color: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.3);
            color: var(--text-light);
        }
        
        .status-success {
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: var(--text-light);
        }
        
        .status-error {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: var(--text-light);
        }
        
        .progress-container {
            margin-top: 15px;
            height: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 235, 59, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Glow effects */
        .glow {
            position: fixed;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.3;
            z-index: -1;
        }
        
        .glow-1 {
            width: 300px;
            height: 300px;
            background: var(--primary);
            top: -150px;
            left: -150px;
        }
        
        .glow-2 {
            width: 400px;
            height: 400px;
            background: var(--accent);
            bottom: -200px;
            right: -200px;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            main {
                padding: 100px 5% 60px;
            }
            
            .section-title {
                font-size: 1.8rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="glow glow-1"></div>
    <div class="glow glow-2"></div>
    
    <!-- Navigation bar -->
    <nav>
        <div class="logo-container">
            <div class="logo-img">MG</div>
            <div class="logo-text">Music Generator</div>
        </div>
    </nav>
    
    <!-- Main content -->
    <main>
        <!-- Lyrics Generator Section -->
        <section class="generator-section">
            <h2 class="section-title">AI Lyrics Generator</h2>
            
            <form id="lyrics-generator-form">
                <div class="form-group">
                    <label for="seed">Seed Text (optional)</label>
                    <input type="text" id="seed" name="seed" placeholder="Enter a few words to start your lyrics">
                </div>
                
                <div class="form-group">
                    <label for="emotion">Emotion</label>
                    <select id="emotion" name="emotion">
                        <option value="happy">Happy</option>
                        <option value="sad">Sad</option>
                        <option value="emotional">Emotional</option>
                        <option value="energetic">Energetic</option>
                        <option value="romantic">Romantic</option>
                        <option value="relaxed">Relaxed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="structure">Song Structure (comma separated)</label>
                    <input type="text" id="structure" name="structure" placeholder="verse, chorus, verse, chorus, bridge, chorus">
                </div>
                
                <button type="submit" class="btn btn-primary" id="generate-lyrics-btn">
                    <span id="lyrics-btn-text">Generate Lyrics</span>
                </button>
            </form>
            
            <div class="status" id="lyrics-status"></div>
            
            <div class="result-container" id="lyrics-result-container">
                <h3 class="result-title">Generated Lyrics</h3>
                <div class="lyrics-result" id="lyrics-result"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="copy-lyrics-btn">
                        <i class="fas fa-copy"></i> Copy Lyrics
                    </button>
                    <button class="btn btn-secondary" id="use-for-music-btn">
                        <i class="fas fa-music"></i> Use for Music Generation
                    </button>
                </div>
            </div>

            <!-- Add this after the lyrics-result-container -->
            <div class="result-container" id="refined-lyrics-container" style="display: none;">
                <h3 class="result-title">Refined Lyrics <span class="ai-badge">AI Enhanced</span></h3>
                <div class="lyrics-result" id="refined-lyrics-result"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="copy-refined-lyrics-btn">
                        <i class="fas fa-copy"></i> Copy Refined Lyrics
                    </button>
                    <button class="btn btn-secondary" id="use-refined-for-music-btn">
                        <i class="fas fa-music"></i> Use for Music Generation
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Music Generator Section -->
        <section class="generator-section">
            <h2 class="section-title">AI Music Generator</h2>
            
            <form id="music-generator-form">
                <div class="form-group">
                    <label for="lyrics">Lyrics</label>
                    <textarea id="lyrics" name="lyrics" placeholder="Enter your lyrics with section markers like [VERSE], [CHORUS], etc." required></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary" id="generate-music-btn">
                    <span id="music-btn-text">Generate Music</span>
                </button>
            </form>
            
            <div class="status" id="music-status"></div>
            
            <div class="result-container" id="music-result-container">
                <h3 class="result-title">Generated Music</h3>
                <audio controls class="audio-player" id="audio-player"></audio>
                
                <div class="action-buttons">
                    <a class="btn btn-secondary" id="download-music-btn">
                        <i class="fas fa-download"></i> Download Music
                    </a>
                    <button class="btn btn-secondary" id="new-music-btn">
                        <i class="fas fa-redo"></i> Generate New
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if models are initialized
            checkModelsStatus();
            
            // Lyrics Generation Form
            const lyricsForm = document.getElementById('lyrics-generator-form');
            const lyricsResult = document.getElementById('lyrics-result');
            const refinedLyricsResult = document.getElementById('refined-lyrics-result');
            const lyricsResultContainer = document.getElementById('lyrics-result-container');
            const refinedLyricsContainer = document.getElementById('refined-lyrics-container');
            const lyricsStatus = document.getElementById('lyrics-status');
            const generateLyricsBtn = document.getElementById('generate-lyrics-btn');
            const lyricsBtnText = document.getElementById('lyrics-btn-text');

            // Modify your existing lyrics form submission handler
            lyricsForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log("Form submitted"); // Debug log
                
                // Reset UI
                lyricsResultContainer.style.display = 'none';
                refinedLyricsContainer.style.display = 'none';
                lyricsStatus.style.display = 'none';
                
                // Show loading state
                generateLyricsBtn.disabled = true;
                lyricsBtnText.innerHTML = '<span class="spinner"></span> Generating...';
                console.log("UI reset and loading state shown"); // Debug log
                
                try {
                    console.log("Making API request..."); // Debug log
                    const response = await fetch('/generate_lyrics', {
                        method: 'POST',
                        body: new FormData(lyricsForm)
                    });
                    
                    console.log("Response received:", response); // Debug log
                    const data = await response.json();
                    console.log("Response data:", data); // Debug log
                    
                    if (data.success) {
                        console.log("Success - displaying lyrics"); // Debug log
                        lyricsResult.textContent = data.initial_lyrics;
                        refinedLyricsResult.textContent = data.refined_lyrics;
                        
                        lyricsResultContainer.style.display = 'block';
                        refinedLyricsContainer.style.display = 'block';
                        
                        lyricsStatus.textContent = 'Lyrics generated and enhanced with AI!';
                        lyricsStatus.className = 'status status-success';
                        lyricsStatus.style.display = 'block';
                    } else {
                        console.log("Error from server:", data.error); // Debug log
                        lyricsStatus.textContent = data.error || 'Error generating lyrics';
                        lyricsStatus.className = 'status status-error';
                        lyricsStatus.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Fetch error:", error); // Debug log
                    lyricsStatus.textContent = 'Error connecting to server';
                    lyricsStatus.className = 'status status-error';
                    lyricsStatus.style.display = 'block';
                } finally {
                    generateLyricsBtn.disabled = false;
                    lyricsBtnText.textContent = 'Generate Lyrics';
                    console.log("Request completed"); // Debug log
                }
            });

            // Copy lyrics button
            document.getElementById('copy-lyrics-btn').addEventListener('click', function() {
                navigator.clipboard.writeText(lyricsResult.textContent).then(() => {
                    const status = document.getElementById('lyrics-status');
                    status.textContent = 'Lyrics copied to clipboard!';
                    status.className = 'status status-success';
                    status.style.display = 'block';
                    
                    // Hide after 3 seconds
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                });
            });
            
            // Use lyrics for music generation button
            document.getElementById('use-for-music-btn').addEventListener('click', function() {
                document.getElementById('lyrics').value = lyricsResult.textContent;
                
                // Scroll to music generator section
                document.querySelector('#music-generator-form').scrollIntoView({
                    behavior: 'smooth'
                });
            });
            
            // Music Generation Form
            const musicForm = document.getElementById('music-generator-form');
            const musicResultContainer = document.getElementById('music-result-container');
            const audioPlayer = document.getElementById('audio-player');
            const musicStatus = document.getElementById('music-status');
            const generateMusicBtn = document.getElementById('generate-music-btn');
            const musicBtnText = document.getElementById('music-btn-text');
            const downloadMusicBtn = document.getElementById('download-music-btn');
            const newMusicBtn = document.getElementById('new-music-btn');
            
            let musicJobId = null;
            let statusCheckInterval = null;
            
            musicForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Reset UI
                musicResultContainer.style.display = 'none';
                musicStatus.style.display = 'none';
                
                // Show loading state
                generateMusicBtn.disabled = true;
                musicBtnText.innerHTML = '<span class="spinner"></span> Generating...';
                
                // Get form data
                const formData = new FormData(musicForm);
                
                try {
                    // Send request to server
                    const response = await fetch('/generate_music', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Store job ID
                    musicJobId = data.job_id;
                    
                    // Show processing status
                    musicStatus.innerHTML = `
                        <div>Processing your music... This may take a minute.</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="music-progress-bar"></div>
                        </div>
                    `;
                    musicStatus.className = 'status status-processing';
                    musicStatus.style.display = 'block';
                    
                    // Start checking status
                    startMusicStatusCheck();
                } catch (error) {
                    musicStatus.textContent = error.message || 'Error starting music generation';
                    musicStatus.className = 'status status-error';
                    musicStatus.style.display = 'block';
                    
                    // Reset button state
                    generateMusicBtn.disabled = false;
                    musicBtnText.textContent = 'Generate Music';
                }
            });
            
            function startMusicStatusCheck() {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                }
                
                statusCheckInterval = setInterval(async () => {
                    if (!musicJobId) {
                        clearInterval(statusCheckInterval);
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/music_status/${musicJobId}`);
                        const data = await response.json();
                        
                        // Update progress
                        const progressBar = document.getElementById('music-progress-bar');
                        if (progressBar) {
                            progressBar.style.width = `${data.progress}%`;
                        }
                        
                        if (data.status === 'completed') {
                            // Generation complete
                            clearInterval(statusCheckInterval);
                            
                            // Set audio source
                            audioPlayer.src = data.download_url;
                            
                            // Set download link
                            downloadMusicBtn.href = data.download_url;
                            downloadMusicBtn.download = `generated_music_${musicJobId}.wav`;
                            
                            // Show results
                            musicResultContainer.style.display = 'block';
                            
                            // Update status
                            musicStatus.textContent = 'Music generated successfully!';
                            musicStatus.className = 'status status-success';
                            
                            // Reset button state
                            generateMusicBtn.disabled = false;
                            musicBtnText.textContent = 'Generate Music';
                        } else if (data.status === 'failed') {
                            // Generation failed
                            clearInterval(statusCheckInterval);
                            
                            musicStatus.textContent = data.error || 'Music generation failed';
                            musicStatus.className = 'status status-error';
                            
                            // Reset button state
                            generateMusicBtn.disabled = false;
                            musicBtnText.textContent = 'Generate Music';
                        }
                    } catch (error) {
                        console.error('Error checking status:', error);
                    }
                }, 2000); // Check every 2 seconds
            }
            
            // New music button
            newMusicBtn.addEventListener('click', function() {
                musicForm.reset();
                musicResultContainer.style.display = 'none';
                musicStatus.style.display = 'none';
            });
            
            // Check if models are initialized
            async function checkModelsStatus() {
                try {
                    const response = await fetch('/health');
                    const data = await response.json();
                    
                    if (!data.lyrics_model_initialized) {
                        showAlert('Lyrics model not initialized. Some features may not work.', 'error');
                    }
                    
                    if (!data.music_generation_ready) {
                        showAlert('Music generation not ready. Some features may not work.', 'error');
                    }
                    
                    // Populate emotions if available
                    if (data.emotions && data.emotions.length > 0) {
                        const emotionSelect = document.getElementById('emotion');
                        emotionSelect.innerHTML = '';
                        
                        data.emotions.forEach(emotion => {
                            const option = document.createElement('option');
                            option.value = emotion;
                            option.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                            emotionSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error checking models status:', error);
                }
            }
            
            function showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `status status-${type}`;
                alertDiv.textContent = message;
                alertDiv.style.marginTop = '20px';
                document.querySelector('main').prepend(alertDiv);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        });
    </script>
</body>
</html>